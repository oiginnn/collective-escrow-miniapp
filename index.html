<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Collective Escrow</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body style="background:#0f0f0f;color:white;font-family:sans-serif;margin:0">
  <div style="padding:16px;border-bottom:1px solid #222;display:flex;gap:10px;align-items:center">
    <div style="font-weight:700">Collective Escrow</div>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button id="tabFeed" style="padding:8px 10px;border-radius:10px;border:1px solid #333;background:#111;color:white">Feed</button>
      <button id="tabMy" style="padding:8px 10px;border-radius:10px;border:1px solid #333;background:#111;color:white">My</button>
    </div>
  </div>

  <div id="screen" style="padding:16px">Loading…</div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    const API = "https://collective-escrow-backend.onrender.com";

    // state
    let current = "feed";
    let lotsCache = [];
    let donateLotId = null;

    function setScreen(html) {
      document.getElementById("screen").innerHTML = html;
    }

    function fmtDate(iso) {
      try { return new Date(iso).toLocaleString(); } catch { return iso; }
    }

    function progressBar(p) {
      const pct = Math.round((p || 0) * 100);
      return `
        <div style="background:#222;border-radius:999px;overflow:hidden;height:10px;margin-top:10px">
          <div style="width:${pct}%;height:10px;background:#4ade80"></div>
        </div>
        <div style="font-size:12px;opacity:.7;margin-top:6px">Progress</div>
      `;
    }

    function lotCard(lot) {
      const img = (lot.media && lot.media[0]) ? lot.media[0] : "";
      return `
        <div style="border:1px solid #2a2a2a;border-radius:16px;padding:12px;margin-bottom:12px">
          ${img ? `<img src="${img}" style="width:100%;border-radius:12px;max-height:220px;object-fit:cover" />` : ``}
          <div style="margin-top:10px;font-size:16px;font-weight:700">${lot.title}</div>
          <div style="margin-top:6px;font-size:13px;opacity:.8">${lot.description || ""}</div>

          ${progressBar(lot.progress || 0)}
          <div style="margin-top:8px;font-size:12px;opacity:.7">Ends: ${fmtDate(lot.ends_at)}</div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button style="flex:1;padding:10px;border-radius:12px;border:0;background:#3b82f6;color:white"
              onclick="alert('Participate — next step')">
              Participate
            </button>
            <button style="flex:1;padding:10px;border-radius:12px;border:1px solid #444;background:transparent;color:white"
              onclick="alert('Buy now — next step')">
              Buy now
            </button>
            <button style="flex:1;padding:10px;border-radius:12px;border:1px solid #444;background:transparent;color:white"
              onclick="openDonate('${lot.id}')">
              DONATE
            </button>
          </div>
        </div>
      `;
    }

    async function loadLots() {
      const r = await fetch(API + "/api/lots");
      const d = await r.json();
      lotsCache = d.lots || [];
    }

    function renderFeed() {
      if (!lotsCache.length) {
        setScreen("<div>No active lots yet.</div>");
        return;
      }
      setScreen(lotsCache.map(lotCard).join(""));
    }

    function openDonate(lotId) {
      donateLotId = lotId;
      current = "donate";
      renderDonate();
    }

    function renderDonate() {
      const lot = lotsCache.find(x => x.id === donateLotId);
      const title = lot ? lot.title : "Lot";

      setScreen(`
        <div style="font-size:18px;font-weight:700;margin-bottom:8px">Donate</div>
        <div style="opacity:.8;margin-bottom:14px">To: <b>${title}</b></div>

        <div style="font-size:12px;opacity:.7;margin-bottom:6px">Amount (USDT)</div>
        <input id="donateAmount" type="number" min="1" step="0.01"
          style="width:100%;padding:12px;border-radius:12px;border:1px solid #333;background:#111;color:white;font-size:16px"
          placeholder="e.g. 10" />

        <div style="margin-top:10px;font-size:12px;opacity:.7">
          Platform fee: <b>1%</b> (included)
        </div>

        <div style="display:flex;gap:10px;margin-top:16px">
          <button style="flex:1;padding:12px;border-radius:12px;border:1px solid #444;background:transparent;color:white"
            onclick="goFeed()">Back</button>
          <button style="flex:1;padding:12px;border-radius:12px;border:0;background:#22c55e;color:black;font-weight:700"
            onclick="confirmDonate()">Confirm</button>
        </div>

        <div id="donateStatus" style="margin-top:14px;font-size:13px;opacity:.85"></div>
      `);
    }

    async function confirmDonate() {
      const el = document.getElementById("donateAmount");
      const status = document.getElementById("donateStatus");
      const amount = Number(el.value);

      if (!Number.isFinite(amount) || amount < 1) {
        status.innerText = "Enter an amount >= 1";
        return;
      }

      status.innerText = "Sending…";

      const r = await fetch(API + "/api/donate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ initData: tg.initData, lotId: donateLotId, amount })
      });

      const d = await r.json();
      if (!r.ok || !d.ok) {
        status.innerText = "Donate failed: " + (d.error || "unknown");
        return;
      }

      status.innerText = "✅ Donation recorded.";
      // не показываем суммы публично, просто успех
    }

    function goFeed() {
      current = "feed";
      renderFeed();
    }

    async function renderMy() {
      setScreen(`<div style="opacity:.8">Loading…</div>`);
      const r = await fetch(API + "/api/me/donations", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ initData: tg.initData })
      });
      const d = await r.json();
      if (!r.ok) {
        setScreen("Failed to load.");
        return;
      }

      const items = d.donations || [];
      if (!items.length) {
        setScreen(`<div style="font-size:18px;font-weight:700;margin-bottom:10px">My</div>
                  <div>No donations yet.</div>`);
        return;
      }

      const rows = items.map(x => `
        <div style="border:1px solid #2a2a2a;border-radius:14px;padding:12px;margin-bottom:10px">
          <div style="font-weight:700">${x.lot_title}</div>
          <div style="opacity:.8;margin-top:4px">${Number(x.amount).toFixed(2)} ${x.currency}</div>
          <div style="font-size:12px;opacity:.7;margin-top:6px">${fmtDate(x.created_at)}</div>
        </div>
      `).join("");

      setScreen(`
        <div style="font-size:18px;font-weight:700;margin-bottom:10px">My donations</div>
        ${rows}
      `);
    }

    // tabs
    document.getElementById("tabFeed").onclick = async () => {
      current = "feed";
      renderFeed();
    };
    document.getElementById("tabMy").onclick = async () => {
      current = "my";
      await renderMy();
    };

    // init
    (async () => {
      try {
        await loadLots();
        renderFeed();
      } catch (e) {
        setScreen("Failed to load lots.");
      }
    })();
  </script>
</body>
</html>
