<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Collective Escrow</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body style="background:#0f0f0f;color:white;font-family:sans-serif;margin:0">
  <div style="padding:16px;border-bottom:1px solid #222;display:flex;gap:10px;align-items:center">
    <div style="font-weight:800">Collective Escrow</div>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button id="tabFeed" style="padding:8px 10px;border-radius:10px;border:1px solid #333;background:#111;color:white">Feed</button>
      <button id="tabMy" style="padding:8px 10px;border-radius:10px;border:1px solid #333;background:#111;color:white">My</button>
    </div>
  </div>

  <div id="debug" style="padding:12px 16px;border-bottom:1px solid #222;font-size:12px;opacity:.85">
    INITDATA: checking…
  </div>

  <div id="screen" style="padding:16px">Loading…</div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    const API = "https://collective-escrow-backend.onrender.com";

    let lotsCache = [];
    let donateLotId = null;

    function setScreen(html) { document.getElementById("screen").innerHTML = html; }
    function fmtDate(iso) { try { return new Date(iso).toLocaleString(); } catch { return iso; } }

    function updateDebug() {
      const initData = tg.initData || "";
      const hasHash = initData.includes("hash=");
      const hasUser = initData.includes("user=");
      const len = initData.length;

      document.getElementById("debug").innerHTML =
        `INITDATA len=<b>${len}</b> | hash=<b>${hasHash}</b> | user=<b>${hasUser}</b> | platform=<b>${tg.platform || "?"}</b>`;
    }

    updateDebug();

    function progressBar(p) {
      const pct = Math.round((p || 0) * 100);
      return `
        <div style="background:#222;border-radius:999px;overflow:hidden;height:10px;margin-top:10px">
          <div style="width:${pct}%;height:10px;background:#4ade80"></div>
        </div>
        <div style="font-size:12px;opacity:.7;margin-top:6px">Progress</div>
      `;
    }

    function lotCard(lot) {
      const img = (lot.media && lot.media[0]) ? lot.media[0] : "";
      return `
        <div style="border:1px solid #2a2a2a;border-radius:16px;padding:12px;margin-bottom:12px">
          ${img ? `<img src="${img}" style="width:100%;border-radius:12px;max-height:220px;object-fit:cover" />` : ``}
          <div style="margin-top:10px;font-size:16px;font-weight:800">${lot.title}</div>
          <div style="margin-top:6px;font-size:13px;opacity:.8">${lot.description || ""}</div>

          ${progressBar(lot.progress || 0)}
          <div style="margin-top:8px;font-size:12px;opacity:.7">Ends: ${fmtDate(lot.ends_at)}</div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button style="flex:1;padding:10px;border-radius:12px;border:0;background:#3b82f6;color:white"
              onclick="alert('Participate — next step')">
              Participate
            </button>
            <button style="flex:1;padding:10px;border-radius:12px;border:1px solid #444;background:transparent;color:white"
              onclick="alert('Buy now — next step')">
              Buy now
            </button>
            <button style="flex:1;padding:10px;border-radius:12px;border:1px solid #444;background:transparent;color:white"
              onclick="openDonate('${lot.id}')">
              DONATE
            </button>
          </div>
        </div>
      `;
    }

    async function loadLots() {
      const r = await fetch(API + "/api/lots");
      const text = await r.text();
      let d = null;
      try { d = JSON.parse(text); } catch {}
      if (!r.ok) throw new Error(d?.error || text || ("HTTP " + r.status));
      lotsCache = d.lots || [];
    }

    function renderFeed() {
      if (!lotsCache.length) {
        setScreen("<div>No active lots yet.</div>");
        return;
      }
      setScreen(lotsCache.map(lotCard).join(""));
    }

    function openDonate(lotId) {
      donateLotId = lotId;
      renderDonate();
    }

    function renderDonate() {
      const lot = lotsCache.find(x => x.id === donateLotId);
      const title = lot ? lot.title : "Lot";

      setScreen(`
        <div style="font-size:18px;font-weight:800;margin-bottom:8px">Donate</div>
        <div style="opacity:.85;margin-bottom:14px">To: <b>${title}</b></div>

        <div style="font-size:12px;opacity:.7;margin-bottom:6px">Amount (USDT)</div>
        <input id="donateAmount" type="number" min="1" step="0.01"
          style="width:100%;padding:12px;border-radius:12px;border:1px solid #333;background:#111;color:white;font-size:16px"
          placeholder="e.g. 10" />

        <div style="margin-top:10px;font-size:12px;opacity:.75">
          Platform fee: <b>1%</b>
        </div>

        <div style="display:flex;gap:10px;margin-top:16px">
          <button style="flex:1;padding:12px;border-radius:12px;border:1px solid #444;background:transparent;color:white"
            onclick="renderFeed()">Back</button>
          <button style="flex:1;padding:12px;border-radius:12px;border:0;background:#22c55e;color:black;font-weight:900"
            onclick="confirmDonate()">Confirm</button>
        </div>

        <div id="donateStatus" style="margin-top:14px;font-size:13px;opacity:.9"></div>
      `);
    }

    async function confirmDonate() {
      updateDebug();

      const el = document.getElementById("donateAmount");
      const status = document.getElementById("donateStatus");
      const amount = Number(el.value);

      if (!Number.isFinite(amount) || amount < 1) {
        status.innerText = "Enter an amount >= 1";
        return;
      }

      if (!tg.initData || !tg.initData.includes("hash=")) {
        status.innerText = "InitData missing (open ONLY inside Telegram Mini App).";
        return;
      }

      status.innerText = "Sending…";

      try {
        const r = await fetch(API + "/api/donate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ initData: tg.initData, lotId: donateLotId, amount })
        });

        const text = await r.text();
        let d = null;
        try { d = JSON.parse(text); } catch {}

        if (!r.ok || !d?.ok) {
          status.innerText = "Donate failed: " + (d?.error || text || ("HTTP " + r.status));
          return;
        }

        status.innerText = "✅ Donation recorded.";
      } catch (e) {
        status.innerText = "Network error: " + e.message;
      }
    }

    async function renderMy() {
      updateDebug();
      setScreen(`<div style="opacity:.85">Loading…</div>`);

      try {
        const r = await fetch(API + "/api/me/donations", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ initData: tg.initData })
        });

        const text = await r.text();
        let d = null;
        try { d = JSON.parse(text); } catch {}

        if (!r.ok) {
          setScreen("Failed: " + (d?.error || text || ("HTTP " + r.status)));
          return;
        }

        const items = d.donations || [];
        if (!items.length) {
          setScreen(`<div style="font-size:18px;font-weight:800;margin-bottom:10px">My donations</div>
                     <div>No donations yet.</div>`);
          return;
        }

        const rows = items.map(x => `
          <div style="border:1px solid #2a2a2a;border-radius:14px;padding:12px;margin-bottom:10px">
            <div style="font-weight:800">${x.lot_title}</div>
            <div style="opacity:.85;margin-top:4px">${Number(x.amount).toFixed(2)} ${x.currency}</div>
            <div style="font-size:12px;opacity:.7;margin-top:6px">${fmtDate(x.created_at)}</div>
          </div>
        `).join("");

        setScreen(`
          <div style="font-size:18px;font-weight:800;margin-bottom:10px">My donations</div>
          ${rows}
        `);
      } catch (e) {
        setScreen("Failed: " + e.message);
      }
    }

    document.getElementById("tabFeed").onclick = () => renderFeed();
    document.getElementById("tabMy").onclick = () => renderMy();

    (async () => {
      try {
        await loadLots();
        renderFeed();
      } catch (e) {
        setScreen("Failed to load lots: " + e.message);
      }
    })();
  </script>
</body>
</html>
