<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Collective Escrow</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body style="background:#0f0f0f;color:white;font-family:sans-serif;padding:16px">
  <h3 style="margin:0 0 12px 0">Collective Escrow</h3>

  <div id="feed">Loadingâ€¦</div>

  <script>
    const API = "https://collective-escrow-backend.onrender.com";

    function bar(progress) {
      const pct = Math.round(progress * 100);
      return `
        <div style="background:#222;border-radius:999px;overflow:hidden;height:10px;margin-top:8px">
          <div style="width:${pct}%;height:10px;background:#4ade80"></div>
        </div>
        <div style="font-size:12px;opacity:.7;margin-top:6px">Progress</div>
      `;
    }

    function card(lot) {
      const img = (lot.media && lot.media[0]) ? lot.media[0] : "";
      const ends = new Date(lot.ends_at).toLocaleString();
      return `
        <div style="border:1px solid #2a2a2a;border-radius:16px;padding:12px;margin-bottom:12px">
          ${img ? `<img src="${img}" style="width:100%;border-radius:12px;max-height:220px;object-fit:cover" />` : ``}
          <div style="margin-top:10px;font-size:16px;font-weight:600">${lot.title}</div>
          <div style="margin-top:6px;font-size:13px;opacity:.8">${lot.description || ""}</div>
          ${bar(lot.progress || 0)}
          <div style="margin-top:10px;font-size:12px;opacity:.7">Ends: ${ends}</div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button style="flex:1;padding:10px;border-radius:12px;border:0;background:#3b82f6;color:white"
              onclick="alert('Next step: participate flow')">
              Participate
            </button>
            <button style="flex:1;padding:10px;border-radius:12px;border:1px solid #444;background:transparent;color:white"
              onclick="alert('Next step: buy now flow')">
              Buy now
            </button>
            <button style="flex:1;padding:10px;border-radius:12px;border:1px solid #444;background:transparent;color:white"
              onclick="alert('Next step: support flow')">
              Support
            </button>
          </div>
        </div>
      `;
    }

    fetch(API + "/api/lots")
      .then(r => r.json())
      .then(data => {
        const lots = data.lots || [];
        if (!lots.length) {
          document.getElementById("feed").innerHTML = "<div>No active lots yet.</div>";
          return;
        }
        document.getElementById("feed").innerHTML = lots.map(card).join("");
      })
      .catch(() => {
        document.getElementById("feed").innerHTML = "Failed to load lots.";
      });
  </script>
</body>
</html>
